name: CI - BackupMonitor API

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
            version: 9

      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
            path: ~/.pnpm-store
            key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
            restore-keys: |
                ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm  lint

      - name: Test
        run: |
            pnpm run test:coverage
            node -e "const c=require('./coverage/coverage-summary.json'); \
                const pct=c.total.statements.pct; \
                if(pct<70) { console.error('Coverage below 70%:', pct); process.exit(1); }"

      - name: Coverage
        run: pnpm run test:coverage
        # TODO: adicionar verificação automática de limiar >= 70%

      - name: SAST (CodeQL/Semgrep)
        run: echo "Rodando SAST fictício (CodeQL/Semgrep)..."
        # TODO: trocar por action oficial do CodeQL ou job com Semgrep
        # TODO: falhar o job se encontrar vulnerabilidades HIGH/CRITICAL

      - name: Build
        run: pnpm build
        # TODO: gerar imagem Docker/artefatos de verdade
